<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<script src="js/konva.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<style>
			.buttons {
				margin-top: 15px;
			}
			
			.error {
				border: solid red;
			}
			
			.container {
				margin-top: 10px;
			}
		</style>
	</head>
	<body>
		<div id="sizer">
			<input id="width" type="number" value=400></input> X 
			<input id="height" type="number" value="300"></input>
			<button style="margin-top: 10px;" onclick="create_stage()">Anlegen</button>
			<a id="download_json">Download JSON</a>
		</div>
		<div class="buttons">
			<button id="spawn" onclick="add_box(7, 20, '#FFFFFF', 'spawn')">Start-Punkt</button>
			<button id="box1" onclick="add_box(30, 30, '#00D2FF')">30x30</button>
			<button id="box2" onclick="add_box(60, 60, '#00D2FF')">60x60</button>
			<button id="box3" onclick="add_box(100, 10, '#00D2FF')">100x10</button>
			<button id="spawn" onclick="add_box(7, 20, '#8EFF8A', 'exit')">Ausgang</button>
			<button id="save" onclick="save()">Speichern</button>
			<div style="margin-top: 15px">
				<input id="custom_width" type="number" value="10"/>X
				<input id="custom_height" type="number" value="10"/>
				<button id="custom_box" onclick="add_custom_box()">eigene</button>
				<button id="float" onclick="add_float(60, 10, '+')">schwebe (rechts)</button>
				<button id="float" onclick="add_float(60, 10, '-')">schwebe (links)</button>
				<button id="float" onclick="add_float(60, 10, 'u')">schwebe (hoch)</button>
				<button id="float" onclick="add_float(60, 10, 'd')">schwebe (runter)</button>
			</div>
			<button id="delete" onclick="delete_object()">entfernen</button>
		</div>
		<div id="container" class="container"></div>
		
		<script>
			/*$(window).click(function(e) {
				var x = e.clientX, y = e.clientY,
				elementMouseIsOver = document.elementFromPoint(x, y);
				console.log(elementMouseIsOver.attrs.x);
			});*/
			
			var stage = undefined;
			var level_json = {"obstacles": {}, "exit": undefined, "spawn": undefined, "level_width": 1000};
			var objects = [];
			var floats = [];
			var spawn = undefined;
			var exit = undefined;
			var last_selected = undefined;
			
			function save()
			{
				for (index in objects)
				{
					var obj = objects[index];
					var attrs = obj.attrs;
					var x = attrs.x;
					var y = attrs.y;
					var width = attrs.width;
					var height = attrs.height;
					var object_name = index.toString() + Math.random().toString(36).substring(2);
					level_json["obstacles"][object_name] = [x, y ,width, height, 0, 0, 0, "", 0, 0];
				}
				
				for (index in floats)
				{
					var obj = floats[index];
					var float = obj[0];
					var direction = obj[1];
					var parent_attrs = float.parent.attrs
					var x = parent_attrs.x;
					var y = parent_attrs.y;
					var max_x = parent_attrs.x + 100;
					var max_y = y;
					var min_y = y;
					if (direction == "u")
					{
						y += 50;
						min_y = y - 100;
						max_y = y;
					}
					if (direction == "d")
					{
						max_y += 50;
					}
					var attrs = float.attrs;
					var width = attrs.width;
					var height = attrs.height;
					var object_name = index.toString() + Math.random().toString(36).substring(2);
					level_json["obstacles"][object_name] = [x, y ,width, height, 1, x, max_x, direction, min_y, max_y];
				}
				
				var spawn_x = spawn.attrs.x;
				var spawn_y = spawn.attrs.y;
				level_json["spawn"] = [spawn_x, spawn_y, spawn_x];
				
				var exit_x = exit.attrs.x;
				var exit_y = exit.attrs.y;
				var exit_w = exit.attrs.width;
				var exit_h = exit.attrs.height;
				level_json["exit"] = [exit_x, exit_y, exit_w, exit_h];
				
				var json_obj = JSON.stringify(level_json, null, 4);
				var blob = new Blob([json_obj], {type: "application/json"});
				var url  = URL.createObjectURL(blob);
				
				var a = document.getElementById("download_json");
				a.download = "level.json";
				a.href = url;
				a.textContent = "Download JSON";
			}
			
			function create_stage(width = undefined, height = undefined)
			{
				if (width == undefined)
				{
					var width = $("#width").val();
				}
				if (height == undefined)
				{
					var height = $("#height").val();
				}
				if (width == "")
				{
					if ($("#width").hasClass("error") == false)
					{
						$("#width").addClass("error");
					}
					return
				}
				if ($("#width").hasClass("error") == true)
				{
					$("#width").removeClass("error");
				}
				level_json["level_width"] = width;
				level_json["level_height"] = height;
				
				stage = new Konva.Stage({
					container: 'container',
					width: width,
					height: height
				});
				
				$(".konvajs-content").attr("style", ($(".konvajs-content").attr("style") + " border: solid;" ));
			}
			
			function recreate_stage(new_objects, new_floats)
			{
				var w = stage.attrs.width;
				var h = stage.attrs.height;
				create_stage(w, h);
				objects = [];
				floats = [];
				for (index in new_objects)
				{
					var obj = new_objects[index];
					var x = obj.attrs.x;
					var y = obj.attrs.y;
					var w = obj.attrs.width;
					var h = obj.attrs.height;
					var c = obj.attrs.fill;
					add_box(w, h, c, "box", x, y);
				}
				for (index in new_floats)
				{
					var float = new_floats[index];
					var obj = float[0];
					var direction = float[1];
					var parent = float[2];
					var parent_attrs = parent.attrs;
					var w = obj.attrs.width;
					var h = obj.attrs.height;
					var x = parent_attrs.x;
					var y = parent_attrs.y;
					var c = obj.attrs.fill;
					add_float(w, h, direction, c, x, y);
				}
				
				if (spawn != undefined)
				{
					var sx = spawn.attrs.x;
					var sy = spawn.attrs.y;
					var sw = spawn.attrs.width;
					var sh = spawn.attrs.height;
					var sc = spawn.attrs.fill;
					add_box(sw, sh, sc, "spawn", sx, sy);
				}
				if (exit != undefined)
				{
					var ex = exit.attrs.x;
					var ey = exit.attrs.y;
					var ew = exit.attrs.width;
					var eh = exit.attrs.height;
					var ec = exit.attrs.fill;
					add_box(ew, eh, ec, "exit", ex, ey);
				}
			}
			
			function add_custom_box()
			{
				console.log("add custom");
				var width = $("#custom_width").val();
				var height = $("#custom_height").val();
				console.log(width);
				console.log(height);
				add_box(width, height, "#FB8AFF");
			}
			
			function add_box(box_width, box_height, color, type = "box", box_x = undefined, box_y = undefined)
			{
				
				rectX = box_x;
				rectY = box_y;
				if (box_x == undefined)
				{
					var rectX = stage.getWidth() / 2 - 50;
				}
				if (box_y == undefined)
				{
					var rectY = stage.getHeight() / 2 - 25;
				}
				
				var box = new Konva.Rect({
					x: rectX,
					y: rectY,
					width: box_width,
					height: box_height,
					fill: color,
					stroke: 'black',
					strokeWidth: 4,
					draggable: true
				});
				
				box.on('mouseover', function() {
					document.body.style.cursor = 'pointer';
				});
				box.on('mouseout', function() {
					document.body.style.cursor = 'default';
				});
				box.on('click', function(event) {
					if (last_selected != undefined)
					{
						last_selected.attrs.stroke = "black";
						last_selected.draw();
					}
					last_selected = event.target;
					event.target.attrs.stroke = "green";
					event.target.draw();
					console.log(event.target.attrs);
				});

				
				var layer = new Konva.Layer();
				layer.add(box);
				stage.add(layer);
				if (type == "box")
				{
					objects.push(box);
				}
				else if (type == "spawn")
				{
					spawn = box;
				}
				else if (type == "exit")
				{
					exit = box;
				}
			}
		
			function delete_object()
			{
				var new_objects = [];
				var new_floats = [];
				if (last_selected != undefined)
				{
					for (index in objects)
					{
						var obj = objects[index];
						if (obj == last_selected)
						{
							continue
						}
						new_objects.push(obj);
					}
					
					for (index in floats)
					{
						var float = floats[index];
						var obj = float[0];
						var direction = float[1];
						var parent = float[2];
						if (obj == last_selected)
						{
							continue
						}
						new_floats.push([obj, direction, parent]);
					}
					last_selected = undefined;
					console.log(new_objects);
					console.log(new_floats);
					recreate_stage(new_objects, new_floats);
				}
			}
			
			function add_float(fwidth, fheight, direction, color = "#00D2FF", group_x = undefined, group_y = undefined)
			{
				var group = new Konva.Group();
				group.setAttr("draggable", true);
				var fx = 0;
				var fy = 0;
				if (direction == "u")
				{
					fy = 50;
				}
				var float = new Konva.Rect({
					x: fx,
					y: fy,
					width: fwidth,
					height: fheight,
					fill: color,
					stroke: 'black',
					strokeWidth: 4,
					draggable: false
				});
				float.on('mouseover', function() {
					document.body.style.cursor = 'pointer';
				});
				float.on('mouseout', function() {
					document.body.style.cursor = 'default';
				});
				float.on('click', function(event) {
					if (last_selected != undefined)
					{
						last_selected.attrs.stroke = "black";
						last_selected.draw();
					}
					last_selected = event.target;
					event.target.attrs.stroke = "green";
					event.target.draw();
					console.log(event.target.attrs);
				});
				
				var rwidth = fwidth;
				var rheight = fheight;
				var rx = 0;
				var ry = 0;
				if (direction == "+" || direction == "-")
				{
					rwidth += 100;
				}
				else if (direction == "u" || direction == "d")
				{
					rheight = rheight + 50;
				}
				if (direction == "-")
				{
					rx = -100;
				}
				
				var range = new Konva.Rect({
					x: rx,
					y: ry,
					width: rwidth,
					height: rheight,
					fill: '#CCF6FF',
					stroke: 'grey',
					strokeWidth: 1,
					draggable: false
				});
				//#F3C2FF
				group.add(range);
				group.add(float);
				
				if (group_x != undefined)
				{
					group.attrs.x = group_x;
				}
				if (group_y != undefined)
				{
					group.attrs.y = group_y;
				}
				if (group_x == undefined && group_y == undefined)
				{
					group.attrs.x = stage.getWidth() / 2 - 50;
					group.attrs.y = stage.getHeight() / 2 - 25;
				}
				var layer = new Konva.Layer();
				layer.add(group);
				stage.add(layer);
				floats.push([float, direction, float.parent]);
			}
		</script>
	</body>
</html>