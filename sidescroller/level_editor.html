<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<script src="js/konva.js"></script>
		<script src="js/jquery.min.js"></script>
		<style>
			button {
				background: none;
				border-style: solid;
				/*cursor: pointer;*/
				border-radius: 10px;
				border-color: black;
				border-width: 1px;
			}

			button:hover {
				background: #EDF6FD;
			}
			
			input[type=color] {
				background: none;
				border-style: solid;
				cursor: pointer;
				border-color: black;
				border-width: 1px;
				width: 3em;
				padding: 0px;
			}
			
			.input_file{
				width: 0.1px;
				height: 0.1px;
				opacity: 0;
				overflow: hidden;
				position: absolute;
				z-index: -1;
			}
			.input_file + label {
				display: inline-block;
				padding-top: 2px;
				padding-bottom: 2px;
				padding-left: 8px;
				padding-right: 8px;
				border: solid;
				border-width: 1px;
				border-style: groove;
				border-radius: 15px;
			}
			.input_file:focus + label,
			.input_file + label:hover {
				background-color: #EDF6FD;
			}
			.input_file + label {
				cursor: pointer; /* "hand" cursor */
			}
			
			.sizer {
				display: inline;
			}
			
			.buttons {
				margin-top: 15px;
			}
			
			.error {
				border: solid red;
			}
			
			.container {
				margin-top: 20%;
				z-index: 0;
			}
			
			.tools_wrapper {
				height: 10%;
			}
			
			.tools {
				/*height: 10%;*/
				background-color: white;
				width: 95%;
				position: fixed;
				border: solid;
				border-color: black;
				border-width: 2px;
				padding: 10px;
				border-bottom-right-radius: 20px;
				border-bottom-left-radius: 20px;
				border-top: none;
				z-index: 1;
			}
			
			.toggle_button {
				position: fixed;
				left: 90%;
				z-index: 1;
				top: 3px;
			}
			
			.hidden {
				display: none;
			}
		</style>
	</head>
	<body onload="set_level_file()">
		<div class="tools_wrapper">
			<div id="tools" class="tools">
				<div id="sizer" class="sizer">
					<input id="width" type="number" value=400></input> X 
					<input id="height" type="number" value="300"></input>
					<button style="margin-top: 10px;" onclick="create_stage()">Anlegen</button>
					<input type="file" id="upload_json" accept=".json" class="input_file" oninput="set_level_file()"></input>
					<label for="upload_json">Level-Datei laden</label>
					<span id="loaded_level"></span>
				</div>
				<div class="buttons">
					<button id="spawn" onclick="add_box(7, 20, '#FFFFFF', 'spawn')">Start-Punkt</button>
					<button id="box1" onclick="add_box(30, 30)">30x30</button>
					<button id="box2" onclick="add_box(60, 60)">60x60</button>
					<button id="box3" onclick="add_box(100, 10)">100x10</button>
					<button id="exit" onclick="add_box(7, 20, '#8EFF8A', 'exit')">Ausgang</button>
					<button id="save" onclick="save()">Speichern</button>
					<a id="download_json" class="hidden">Download JSON</a>
					<div style="margin-top: 15px;">
						<input id="custom_width" type="number" value="10"/>X
						<input id="custom_height" type="number" value="10"/>
						<button id="custom_box" onclick="add_custom_box()">eigene</button>
						schwebe:<input id="custom_floating" type="checkbox" onclick="toggle_direction_select()">
						<select id="float_direction" disabled="true">
							<option value="u">hoch</option>
							<option value="d">runter</option>
							<option value="-">links</option>
							<option value="+">rechts</option>
						</select>
						<input id="float_distance" type="number" value="100" disabled="true">
					</div>
					<div style="margin-top: 15px;">
						<button id="delete" onclick="delete_object()">entfernen</button>
						<input id="color" type="color" value="#00D2FF" onchange="update_color()"/>
						<input id="color_object" type="color" value="#00D2FF" onchange="update_object_color()"/>
						
						<button id="float" onclick="add_float(60, 10, '+')">schwebe (rechts)</button>
						<button id="float" onclick="add_float(60, 10, '-')">schwebe (links)</button>
						<button id="float" onclick="add_float(60, 10, 'u')">schwebe (hoch)</button>
						<button id="float" onclick="add_float(60, 10, 'd')">schwebe (runter)</button>
					</div>
				</div>
			</div>
		</div>
		<button id="hide_tools" class="toggle_button" onclick="toggle_tools()">
			<img id="arrow_up" src="./images/arrow_up.png"/>
		</button>
		<button id="show_tools" class="toggle_button hidden" onclick="toggle_tools()">
			<img id="arrow_down" src="./images/arrow_down.png/"/>
		</button>
		<div id="container" class="container"></div>
		
		<script>
			/*$(window).click(function(e) {
				var x = e.clientX, y = e.clientY,
				elementMouseIsOver = document.elementFromPoint(x, y);
				console.log(elementMouseIsOver.attrs.x);
			});*/
			
			var stage = undefined;
			var level_json = {"obstacles": {}, "exit": undefined, "spawn": undefined, "level_width": 1000};
			var objects = {};
			var floats = {};
			var spawn = undefined;
			var exit = undefined;
			var last_selected = undefined;
			var last_selected_floating = false;
			var selected_color = $("#color").val();
			
			function toggle_tools()
			{
				var tools = $("#tools");
				var button_hide = $("#hide_tools");
				var button_show = $("#show_tools");
				if ($(tools).hasClass("hidden"))
				{
					$(tools).removeClass("hidden");
					$(button_hide).removeClass("hidden");
					$(button_show).addClass("hidden");
				}
				else
				{
					$(tools).addClass("hidden");
					$(button_hide).addClass("hidden");
					$(button_show).removeClass("hidden");
				}
			}
			
			function set_level_file()
			{
				var uploaded_json = document.getElementById("upload_json").files;
				console.log(uploaded_json);
				if (uploaded_json.length > 0)
				{
					$("#loaded_level").text(uploaded_json[0].name);
				}
			}
			
			function parse_rgb_from_hex(color)
			{
				return [parseInt(color.substr(1,2),16),
					parseInt(color.substr(3,2),16),
					parseInt(color.substr(5,2),16)]
			}
			
			function parse_hex_from_rgb(color_rgb)
			{
				var hex_string = "#";
				for (i in color_rgb)
				{
					var part = color_rgb[i];
					var hex_part = part.toString(16);
					var hex_value = hex_part.length == 1 ? "0" + hex_part : hex_part;
					hex_string += hex_value;
				}
				return hex_string;
			}
			
			function update_color()
			{
				selected_color = $("#color").val();
			}
			
			function update_object_color()
			{
				var selected_color = $("#color_object").val();
				var color_rgb = parse_rgb_from_hex(selected_color);
				if (last_selected != undefined)
				{
					last_selected.attrs.fill = selected_color;
					if (last_selected_floating)
					{
						var range = last_selected.parent.children[0]
						var color_lightened = "#";
						for (i in color_rgb)
						{
							var part = color_rgb[i];
							var part_ = part += 50;
							var part_ = part_ > 255 ? 255 : part_;
							var hex_value = part_.toString(16);
							color_lightened += hex_value;
						}
						range.attrs.fill = color_lightened;
						range.draw();
					}
					last_selected.draw();
				}
			}
			
			function toggle_direction_select()
			{
				var checked = $("#custom_floating").is(":checked");
				if (checked)
				{
					$("#float_direction").prop("disabled", false);
					$("#float_distance").prop("disabled", false);
				}
				else
				{
					$("#float_direction").prop("disabled", true);
					$("#float_distance").prop("disabled", true);
				}
			}
			
			function save()
			{
				level_json = {"obstacles": {}, "exit": undefined, "spawn": undefined, "level_width": 1000};
				for (key in objects)
				{
					var obj = objects[key];
					var attrs = obj.attrs;
					var x = attrs.x;
					var y = attrs.y;
					var width = attrs.width;
					var height = attrs.height;
					var color = parse_rgb_from_hex(attrs.fill);
					level_json["obstacles"][key] = [x, y ,width, height, 0, 0, 0, "", 0, 0, color];
				}
				
				for (key in floats)
				{
					var obj = floats[key];
					var float = obj[0];
					var direction = obj[1];
					var min_max_diff = obj[2];
					var parent_attrs = float.parent.attrs
					var x = parent_attrs.x;
					var y = parent_attrs.y;
					//var max_x = parent_attrs.x + 100;
					var max_x = x + min_max_diff;
					var max_y = y + min_max_diff;
					var min_x = x;
					var min_y = y;
					if (direction == "u")
					{
						y += float.attrs.y;
						/*y += min_max_diff;
						min_y = y;
						max_y = y;*/
					}
					/*
					if (direction == "d")
					{
						max_y += min_max_diff;
					}*/
					var attrs = float.attrs;
					var width = attrs.width;
					var height = attrs.height;
					var color = parse_rgb_from_hex(attrs.fill);
					level_json["obstacles"][key] = [x, y ,width, height, 1, x, max_x, direction, min_y, max_y, color];
				}
				
				var spawn_x = spawn.attrs.x;
				var spawn_y = spawn.attrs.y;
				level_json["spawn"] = [spawn_x, spawn_y, spawn_x];
				
				var exit_x = exit.attrs.x;
				var exit_y = exit.attrs.y;
				var exit_w = exit.attrs.width;
				var exit_h = exit.attrs.height;
				level_json["exit"] = [exit_x, exit_y, exit_w, exit_h];
				var width = $("#width").val();
				var height = $("#height").val();
				level_json["level_width"] = width;
				level_json["level_height"] = height;
				
				var json_obj = JSON.stringify(level_json, null, 4);
				var blob = new Blob([json_obj], {type: "application/json"});
				var url  = URL.createObjectURL(blob);
				
				var a = document.getElementById("download_json");
				if ($(a).hasClass("hidden"))
				{
					$(a).removeClass("hidden");
				}
				a.download = "level.json";
				a.href = url;
				a.textContent = "Download JSON";
			}
			
			function create_stage(width = undefined, height = undefined)
			{
				var uploaded_json = document.getElementById("upload_json").files;
				if (uploaded_json.length > 0)
				{
					for (i=0; i<uploaded_json.length; i++)
					{
						var reader = new FileReader();
						reader.readAsText(uploaded_json[i], "UTF-8");
						reader.onload = function(event) {
							create_stage_from_json(JSON.parse(event.target.result));
						}
						reader.onerror = function (event) {
							console.log(event.target.result);
						}
						//var j = JSON.parse(content);
					}
					return;
				}
				
				if (width == undefined)
				{
					var width = $("#width").val();
				}
				if (height == undefined)
				{
					var height = $("#height").val();
				}
				if (width == "")
				{
					if ($("#width").hasClass("error") == false)
					{
						$("#width").addClass("error");
					}
					return
				}
				if (height == "")
				{
					if ($("#height").hasClass("error") == false)
					{
						$("#height").addClass("error");
					}
					return
				}
				if ($("#width").hasClass("error") == true)
				{
					$("#width").removeClass("error");
				}
				if ($("#height").hasClass("error") == true)
				{
					$("#height").removeClass("error");
				}
				level_json["level_width"] = width;
				level_json["level_height"] = height;
				
				stage = new Konva.Stage({
					container: 'container',
					width: width,
					height: height
				});
				
				$(".konvajs-content").attr("style", ($(".konvajs-content").attr("style") + " border: solid;" ));
			}
			
			function create_stage_from_json(json_object)
			{
				var obstacles = json_object["obstacles"];
				var spawn = json_object["spawn"];
				var exit = json_object["exit"];
				var width = json_object["level_width"];
				var height = json_object["level_height"];
				
				level_json["level_width"] = width;
				level_json["level_height"] = height;
				
				stage = new Konva.Stage({
					container: 'container',
					width: width,
					height: height
				});
				
				$(".konvajs-content").attr("style", ($(".konvajs-content").attr("style") + " border: solid;" ));
				for (key in obstacles)
				{
					var obj = obstacles[key];
					var x = obj[0];
					var y = obj[1];
					var w = obj[2];
					var h = obj[3];
					var float = obj[4];
					var min_x = obj[5];
					var max_x = obj[6];
					var direction = obj[7];
					var min_y = obj[8];
					var max_y = obj[9];
					var min_max_diff_x = max_x - min_x;
					var min_max_diff_y = max_y - min_y;
					var color_rgb = obj[10];
					if (color_rgb == undefined)
					{
						color_rgb = [0, 210, 255];
					}
					var obj_color = parse_hex_from_rgb(color_rgb);
					if (parseInt(float) == 1)
					{
						var minimum_values = [];
						if (direction == "+" || direction == "-")
						{
							minimum_values = [min_x, max_x];
						}
						else if (direction == "u" || direction == "d")
						{
							minimum_values = [min_y, max_y]
							if (direction == "u")
							{
								y -= min_max_diff_y;
							}
						}
						add_float(w, h, direction, obj_color, x, y, minimum_values);
					}
					else
					{
						add_box(w, h, obj_color, "box", x, y);
					}
				}
				
				var spawn_x = spawn[0];
				var spawn_y = spawn[1];
				add_box(7, 20, "#FFFFFF", "spawn", spawn_x, spawn_y);
				var exit_x = exit[0];
				var exit_y = exit[1];
				add_box(7, 20, "#8EFF8A", "exit", exit_x, exit_y);
			}
			
			function recreate_stage(new_objects, new_floats)
			{
				var w = stage.attrs.width;
				var h = stage.attrs.height;
				create_stage(w, h);
				objects = [];
				floats = [];
				for (key in new_objects)
				{
					var obj = new_objects[key];
					var x = obj.attrs.x;
					var y = obj.attrs.y;
					var w = obj.attrs.width;
					var h = obj.attrs.height;
					var c = obj.attrs.fill;
					add_box(w, h, c, "box", x, y);
				}
				for (key in new_floats)
				{
					var float = new_floats[key];
					var obj = float[0];
					var direction = float[1];
					var parent = obj.parent;
					var parent_attrs = parent.attrs;
					var w = obj.attrs.width;
					var h = obj.attrs.height;
					var x = parent_attrs.x;
					var y = parent_attrs.y;
					var c = obj.attrs.fill;
					add_float(w, h, direction, c, x, y);
				}
				
				if (spawn != undefined)
				{
					var sx = spawn.attrs.x;
					var sy = spawn.attrs.y;
					var sw = spawn.attrs.width;
					var sh = spawn.attrs.height;
					var sc = spawn.attrs.fill;
					add_box(sw, sh, sc, "spawn", sx, sy);
				}
				if (exit != undefined)
				{
					var ex = exit.attrs.x;
					var ey = exit.attrs.y;
					var ew = exit.attrs.width;
					var eh = exit.attrs.height;
					var ec = exit.attrs.fill;
					add_box(ew, eh, ec, "exit", ex, ey);
				}
			}
			
			function add_custom_box()
			{
				var width = parseInt($("#custom_width").val());
				var height = parseInt($("#custom_height").val());
				var floating = $("#custom_floating").is(":checked");
				if (floating)
				{
					var direction = $("#float_direction").val();
					var distance = parseInt($("#float_distance").val());
					add_float(width, height, direction, undefined, undefined, undefined, undefined, distance);
				}
				else
				{
					add_box(width, height);
				}
			}
			
			function add_box(box_width, box_height, color, type = "box", box_x = undefined, box_y = undefined)
			{
				
				rectX = box_x;
				rectY = box_y;
				if (box_x == undefined)
				{
					var rectX = $(document).scrollLeft() + 100;
				}
				if (box_y == undefined)
				{
					var rectY = $(document).scrollTop() + 100;
				}
				
				if (color == undefined)
				{
					color = selected_color;
				}
				
				var box = new Konva.Rect({
					x: rectX,
					y: rectY,
					width: box_width,
					height: box_height,
					fill: color,
					stroke: 'black',
					strokeWidth: 4,
					draggable: true
				});
				
				box.on('mouseover', function() {
					document.body.style.cursor = 'pointer';
				});
				box.on('mouseout', function() {
					document.body.style.cursor = 'default';
				});
				box.on('click', function(event) {
					if (last_selected != undefined)
					{
						last_selected.attrs.stroke = "black";
						last_selected.draw();
					}
					last_selected = event.target;
					last_selected_floating = false;
					$("#color_object").val(event.target.attrs.fill);
					event.target.attrs.stroke = "green";
					event.target.draw();
					console.log(event.target.attrs);
				});
				box.floating = false;

				
				var layer = new Konva.Layer();
				layer.add(box);
				stage.add(layer);
				if (type == "box")
				{
					//objects.push(box);
					var key = Object.keys(objects).length.toString() + Math.random().toString(36).substring(2);
					box.object_key = key;
					objects[key] = box;
				}
				else if (type == "spawn")
				{
					spawn = box;
				}
				else if (type == "exit")
				{
					exit = box;
				}
			}
			
			function delete_object()
			{
				var key = last_selected.object_key;
				if (last_selected.floating)
				{
					var layer = last_selected.parent.parent;
					delete floats[key];
				}
				else
				{
					var layer = last_selected.parent;
					delete objects[key];
				}
				layer.remove();
				//layer.destroy();
			}
			
			function add_float(fwidth, fheight, direction, color, group_x = undefined, group_y = undefined, minimum_values = undefined, distance = undefined)
			{
				if (color == undefined)
				{
					color = selected_color;
				}
				
				if (direction == "+" || direction == "-")
				{
					var min_max_diff = 50
				}
				else if (direction == "u" || direction == "d")
				{
					var min_max_diff = 50
				}
				
				if (minimum_values != undefined)
				{
					min_max_diff = minimum_values[1] - minimum_values[0];
				}
				
				if (distance != undefined)
				{
					min_max_diff = distance;
				}
				
				var color_rgb = parse_rgb_from_hex(color);
				var color_lightened = "#";
				for (i in color_rgb)
				{
					var part = color_rgb[i];
					var part_ = part += 50;
					var part_ = part_ > 255 ? 255 : part_;
					var hex_value = part_.toString(16);
					color_lightened += hex_value;
				}
				
				var group = new Konva.Group();
				group.setAttr("draggable", true);
				var fx = 0;
				var fy = 0;
				if (direction == "u")
				{
					fy = min_max_diff;
				}
				var float = new Konva.Rect({
					x: fx,
					y: fy,
					width: fwidth,
					height: fheight,
					fill: color,
					stroke: 'black',
					strokeWidth: 4,
					draggable: false
				});
				float.on('mouseover', function() {
					document.body.style.cursor = 'pointer';
				});
				float.on('mouseout', function() {
					document.body.style.cursor = 'default';
				});
				float.on('click', function(event) {
					if (last_selected != undefined)
					{
						last_selected.attrs.stroke = "black";
						last_selected.draw();
					}
					last_selected = event.target;
					last_selected_floating = true;
					event.target.attrs.stroke = "green";
					event.target.draw();
					console.log(event.target.attrs);
				});
				float.floating = true;
				
				var rwidth = fwidth;
				var rheight = fheight;
				var rx = 0;
				var ry = 0;
				if (direction == "+" || direction == "-")
				{
					rwidth += min_max_diff;
				}
				else if (direction == "u" || direction == "d")
				{
					rheight += min_max_diff;
				}
				if (direction == "-")
				{
					rx = -min_max_diff;
				}
				var range = new Konva.Rect({
					x: rx,
					y: ry,
					width: rwidth,
					height: rheight,
					fill: color_lightened,
					stroke: 'black',
					strokeWidth: 1,
					draggable: false
				});
				group.add(range);
				group.add(float);
				
				if (group_x != undefined)
				{
					group.attrs.x = group_x;
				}
				if (group_y != undefined)
				{
					group.attrs.y = group_y;
				}
				if (group_x == undefined && group_y == undefined)
				{
					group.attrs.x = $(document).scrollLeft() + 100;
					group.attrs.y = $(document).scrollTop() + 100;
				}
				var layer = new Konva.Layer();
				layer.add(group);
				stage.add(layer);
				//, float.parent
				//floats.push([float, direction, min_max_diff]);
				var key = Object.keys(floats).length.toString() + Math.random().toString(36).substring(2);
				float.object_key = key;
				floats[key] = [float, direction, min_max_diff];
			}
		</script>
	</body>
</html>