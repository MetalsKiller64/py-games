<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<script src="js/konva.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<style>
			.buttons {
				margin-top: 15px;
			}
			
			.error {
				border: solid red;
			}
		</style>
	</head>
	<body>
		<div id="sizer">
			<input id="width" type="number"></input> X 
			<input id="height" type="number" disabled="true" value="300"></input>
			<button style="margin-top: 10px;" onclick="create_stage()">Anlegen</button>
			<a id="download_json">Download JSON</a>
		</div>
		<div class="buttons">
			<button id="spawn" onclick="add_box(7, 20, '#FFFFFF', 'spawn')">Start-Punkt</button>
			<button id="box1" onclick="add_box(30, 30, '#00D2FF')">30x30</button>
			<button id="box2" onclick="add_box(60, 60, '#00D2FF')">60x60</button>
			<button id="box3" onclick="add_box(100, 10, '#00D2FF')">100x10</button>
			<button id="spawn" onclick="add_box(7, 20, '#8EFF8A', 'exit')">Ausgang</button>
			<button id="save" onclick="save()">Speichern</button>
			<div style="margin-top: 15px">
				<input id="custom_width" type="number" value="10"/>X
				<input id="custom_height" type="number" value="10"/>
				<button id="custom_box" onclick="add_custom_box()">eigene</button>
			</div>
			<button id="delete" onclick="delete_box()">entfernen</button>
		</div>
		<div id="container" class="container"></div>
		
		<script>
			/*$(window).click(function(e) {
				var x = e.clientX, y = e.clientY,
				elementMouseIsOver = document.elementFromPoint(x, y);
				console.log(elementMouseIsOver.attrs.x);
			});*/
			
			var stage = undefined;
			var level_json = {"obstacles": {}, "exit": undefined, "spawn": undefined, "level_width": 1000};
			var objects = [];
			var spawn = undefined;
			var exit = undefined;
			var last_selected = undefined;
			
			function save()
			{
				for (index in objects)
				{
					var obj = objects[index];
					var attrs = obj.attrs;
					var x = attrs.x;
					var y = attrs.y;
					var width = attrs.width;
					var height = attrs.height;
					level_json["obstacles"][index] = [x, y ,width, height, 0, 0, 0, ""];
				}
				
				var spawn_x = spawn.attrs.x;
				var spawn_y = spawn.attrs.y;
				level_json["spawn"] = [spawn_x, spawn_y, spawn_x];
				
				var exit_x = exit.attrs.x;
				var exit_y = exit.attrs.y;
				var exit_w = exit.attrs.width;
				var exit_h = exit.attrs.height;
				level_json["exit"] = [exit_x, exit_y, exit_w, exit_h];
				
				var json_obj = JSON.stringify(level_json, null, 4);
				var blob = new Blob([json_obj], {type: "application/json"});
				var url  = URL.createObjectURL(blob);
				
				var a = document.getElementById("download_json");
				a.download = "level.json";
				a.href = url;
				a.textContent = "Download JSON";
			}
			
			function create_stage(width = undefined, height = undefined)
			{
				if (width == undefined)
				{
					var width = $("#width").val();
				}
				if (height == undefined)
				{
					var height = $("#height").val();
				}
				if (width == "")
				{
					if ($("#width").hasClass("error") == false)
					{
						$("#width").addClass("error");
					}
					return
				}
				if ($("#width").hasClass("error") == true)
				{
					$("#width").removeClass("error");
				}
				level_json["level_width"] = width;
				
				stage = new Konva.Stage({
					container: 'container',
					width: width,
					height: height
				});
				
				$(".konvajs-content").attr("style", ($(".konvajs-content").attr("style") + " border: solid;" ));
			}
			
			function recreate_stage(new_objects)
			{
				if (new_objects.length == 0)
				{
					return;
				}
				var w = stage.attrs.width;
				var h = stage.attrs.height;
				create_stage(w, h);
				objects = [];
				for (index in new_objects)
				{
					var obj = new_objects[index];
					var x = obj.attrs.x;
					var y = obj.attrs.y;
					var w = obj.attrs.width;
					var h = obj.attrs.height;
					var c = obj.attrs.fill;
					add_box(w, h, c, "box", x, y);
				}
				if (spawn != undefined)
				{
					var sx = spawn.attrs.x;
					var sy = spawn.attrs.y;
					var sw = spawn.attrs.width;
					var sh = spawn.attrs.height;
					var sc = spawn.attrs.fill;
					add_box(sw, sh, sc, "spawn", sx, sy);
				}
				if (exit != undefined)
				{
					var ex = exit.attrs.x;
					var ey = exit.attrs.y;
					var ew = exit.attrs.width;
					var eh = exit.attrs.height;
					var ec = exit.attrs.fill;
					add_box(ew, eh, ec, "exit", ex, ey);
				}
			}
			
			function add_custom_box()
			{
				console.log("add custom");
				var width = $("#custom_width").val();
				var height = $("#custom_height").val();
				console.log(width);
				console.log(height);
				add_box(width, height, "#FB8AFF");
			}
			
			function add_box(box_width, box_height, color, type = "box", box_x = undefined, box_y = undefined)
			{
				
				rectX = box_x;
				rectY = box_y;
				if (box_x == undefined)
				{
					var rectX = stage.getWidth() / 2 - 50;
				}
				if (box_y == undefined)
				{
					var rectY = stage.getHeight() / 2 - 25;
				}
				
				var box = new Konva.Rect({
					x: rectX,
					y: rectY,
					width: box_width,
					height: box_height,
					fill: color,
					stroke: 'black',
					strokeWidth: 4,
					draggable: true
				});
				
				box.on('mouseover', function() {
					document.body.style.cursor = 'pointer';
				});
				box.on('mouseout', function() {
					document.body.style.cursor = 'default';
				});
				box.on('click', function(event) {
					last_selected = event.target;
					console.log(event.target.attrs);
				});

				
				var layer = new Konva.Layer();
				layer.add(box);
				stage.add(layer);
				if (type == "box")
				{
					objects.push(box);
				}
				else if (type == "spawn")
				{
					spawn = box;
				}
				else if (type == "exit")
				{
					exit = box;
				}
			}
		
		function delete_box()
		{
			var new_objects = [];
			if (last_selected != undefined)
			{
				for (index in objects)
				{
					var obj = objects[index];
					if (obj == last_selected)
					{
						continue
					}
					new_objects.push(obj);
				}
			}
			last_selected = undefined;
			recreate_stage(new_objects);
		}
		</script>
	</body>
</html>